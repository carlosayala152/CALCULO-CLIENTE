<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>SISTEMA DE CORTE v82.0 - REATIVIDADE TOTAL</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; padding: 20px; color: #1e293b; }
        .box { background: white; padding: 30px; border-radius: 15px; max-width: 1100px; margin: auto; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .header { background: #0f172a; color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 25px; }
        .header input, .header select { padding: 8px; margin: 0 5px; text-align: center; border-radius: 5px; border: none; font-weight: bold; font-size: 14px; }
        .header input { width: 75px; }
        
        .no-print { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: center; font-weight: bold; }
        th { background: #334155; color: white; font-size: 11px; text-transform: uppercase; }
        
        .btn { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-calc { background: #10b981; color: white; width: 100%; font-size: 18px; margin: 20px 0; }
        .btn-print { background: #3b82f6; color: white; width: 100%; font-size: 18px; }
        .btn-grade { background: #64748b; color: white; font-size: 11px; }
        
        .sessao-titulo { background: #0f172a; color: white; padding: 15px; margin-top: 40px; border-radius: 8px; font-weight: 800; border-left: 15px solid #10b981; }
        .card { border: 2px solid #0f172a; padding: 20px; margin-top: 20px; border-radius: 10px; background: #fff; page-break-inside: avoid; }
        .card-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #0f172a; padding-bottom: 10px; margin-bottom: 15px; }
        
        .input-edit { width: 60px; padding: 6px; text-align: center; font-weight: bold; border: 2px solid #3b82f6; border-radius: 4px; }
        .input-folha { background: #f0fdf4; border-color: #22c55e; width: 80px; font-size: 18px; }
        .input-molde { background: #f0f9ff; }
        
        .sobra { color: #059669; } 
        .falta { color: #dc2626; }
        
        @media print {
            .no-print, .btn-calc, .btn-print, td button, .header input, .header select { display: none !important; }
            body { background: white; padding: 0; }
            .box { box-shadow: none; max-width: 100%; }
        }
    </style>
</head>
<body>

<div class="box">
    <div class="header">
        <h1>SISTEMA DE CORTE v82.0</h1>
        L: <input type="number" id="L" value="1.56" step="0.01">
        √ÅREA: 
        <select id="A" onchange="recalcularTodosOsCards()">
            <option value="0.50">Pequenas (Biqu√≠ni/Top) - 0.50m</option>
            <option value="0.90" selected>M√©dias (Saia/Shorts) - 0.90m</option>
            <option value="1.30">Grandes (Camisa/Cal√ßa) - 1.30m</option>
            <option value="1.60">Extra G (Macac√£o/Vestido) - 1.60m</option>
        </select>
        Mesa: <input type="number" id="M" value="7.00">
    </div>

    <div class="no-print">
        <button class="btn btn-grade" onclick="setGrade([['38',20],['40',20],['42',20],['44',40],['46',30],['48',30],['50',30],['52',20],['54',20],['56',20],['58',20]])">GRADE EXEMPLO 38-58</button>
        <button class="btn btn-grade" onclick="setGrade([['P',60],['M',160],['G',160],['GG',110]])">GRADE LETRAS</button>
        <button class="btn btn-grade" onclick="addLinha('',0)">+ TAMANHO</button>
    </div>

    <table id="tabelaEntrada" class="no-print">
        <thead><tr><th>TAMANHO</th><th>PEDIDO TOTAL</th><th>A√á√ÉO</th></tr></thead>
        <tbody id="corpoEntrada"></tbody>
    </table>

    <button class="btn btn-calc" onclick="gerarTudo()">‚ö° GERAR ENFESTOS INTERATIVOS</button>
    <button class="btn btn-print" onclick="window.print()">üñ®Ô∏è IMPRIMIR ORDEM DE CORTE</button>

    <div id="display"></div>
</div>

<script>
function addLinha(t, q) {
    var tb = document.getElementById('corpoEntrada');
    var row = tb.insertRow(-1);
    row.innerHTML = `<td><input type="text" value="${t}" class="in-t" style="width:70px"></td>
                     <td><input type="number" value="${q}" class="in-q" style="width:90px"></td>
                     <td><button class="btn" style="background:#ef4444; color:white; padding:5px 10px;" onclick="this.parentElement.parentElement.remove()">X</button></td>`;
}

function setGrade(lista) {
    document.getElementById('corpoEntrada').innerHTML = "";
    lista.forEach(i => addLinha(i[0], i[1]));
}

function recalcularTodosOsCards() {
    document.querySelectorAll('.card').forEach(card => {
        const inputFolha = card.querySelector('.input-folha');
        // Dispara o evento de input manualmente para atualizar os c√°lculos internos
        inputFolha.dispatchEvent(new Event('input', { bubbles: true }));
    });
}

function gerarTudo() {
    const display = document.getElementById('display');
    display.innerHTML = "";

    let peds = [];
    let rows = document.getElementById('corpoEntrada').rows;
    for (let i = 0; i < rows.length; i++) {
        let t = rows[i].querySelector('.in-t').value;
        let q = parseInt(rows[i].querySelector('.in-q').value) || 0;
        if(q > 0) peds.push({t, q});
    }
    if(peds.length === 0) return;

    const L = parseFloat(document.getElementById('L').value);
    const A = parseFloat(document.getElementById('A').value);
    const MESA = parseFloat(document.getElementById('M').value);

    // --- OP√á√ÉO 1: GERAL ---
    display.innerHTML += `<div class="sessao-titulo">Op√ß√£o 1: Plano Geral</div>`;
    renderCard(peds, Math.min(...peds.map(p => p.q)), display, "ORDEM PADR√ÉO");

    // --- OP√á√ÉO 2: AGRUPAMENTO POR MESA ---
    display.innerHTML += `<div class="sessao-titulo">Op√ß√£o 2: Agrupamento Otimizado (Limitado pela Mesa)</div>`;
    let tempPeds = JSON.parse(JSON.stringify(peds));
    let enfIdx = 1;

    while (tempPeds.length > 0) {
        let folhaAlvo = tempPeds[0].q;
        let grupo = [];
        let somaM = 0;

        for (let i = 0; i < tempPeds.length; i++) {
            let item = tempPeds[i];
            if (item.q === folhaAlvo || item.q === folhaAlvo * 2 || (folhaAlvo % item.q === 0)) {
                let mSugerido = Math.round(item.q / folhaAlvo) || 1;
                let rPrevisto = ((somaM + mSugerido) * A) / L;

                if (rPrevisto <= MESA || grupo.length === 0) {
                    grupo.push(tempPeds.splice(i, 1)[0]);
                    somaM += mSugerido;
                    i--;
                }
            }
        }
        renderCard(grupo, folhaAlvo, display, `ENFESTO AGRUPADO #${enfIdx++}`);
    }

    // --- OP√á√ÉO 3: PARES ---
    display.innerHTML += `<div class="sessao-titulo">Op√ß√£o 3: Afinidade de Pares</div>`;
    let peds3 = JSON.parse(JSON.stringify(peds)).sort((a,b) => b.q - a.q);
    while(peds3.length > 0) {
        let i1 = peds3.shift();
        let i2 = null;
        let conf = { fol: i1.q, m1: 1, m2: 0 };
        if(peds3.length > 0) {
            let idxP = peds3.findIndex(x => x.q === i1.q || Math.abs(x.q*2 - i1.q) < 30);
            if(idxP === -1) idxP = 0;
            i2 = peds3.splice(idxP, 1)[0];
            if(i1.q === i2.q) { conf = { fol: Math.floor(i1.q/4), m1: 4, m2: 4 }; } 
            else { conf = { fol: i2.q, m1: Math.round(i1.q/i2.q), m2: 1 }; }
        }
        renderCard(i2 ? [i1, i2] : [i1], conf.fol, display, `OTIMIZADO: ${i1.t}${i2 ? ' + '+i2.t : ''}`, conf);
    }
}

function renderCard(itens, camSugerida, container, titulo, config = null) {
    let card = document.createElement('div');
    card.className = 'card';
    
    let html = `
        <div class="card-header">
            <strong>${titulo}</strong>
            <div>FOLHAS: <input type="number" value="${camSugerida}" class="input-edit input-folha"></div>
        </div>
        <table>
            <thead><tr><th>TAM</th><th>PEDIDO</th><th>MOLDES</th><th>PROD.</th><th>SALDO</th></tr></thead>
            <tbody>`;
    
    itens.forEach((it, idx) => {
        let mldInitial = config ? (idx === 0 ? config.m1 : config.m2) : Math.round(it.q / camSugerida) || 1;
        html += `<tr>
            <td class="tam-nome">${it.t}</td>
            <td class="ped-val">${it.q}</td>
            <td><input type="number" value="${mldInitial}" class="input-edit input-molde"></td>
            <td class="res-total">0</td>
            <td class="res-saldo">0</td>
        </tr>`;
    });

    html += `</tbody></table><div style="margin-top:15px; font-weight:bold; display:flex; justify-content:space-between; font-size:14px;">
        <span>RISCO: <span class="risco-val">0</span>m</span>
        <span>MESA: <span class="mesa-status-icon"></span></span>
    </div>`;
    
    card.innerHTML = html;
    container.appendChild(card);

    // FUN√á√ÉO DE C√ÅLCULO INTERNA DO CARD
    const calcInterno = (event) => {
        const isFolhaInput = event && event.target.classList.contains('input-folha');
        const L_FIXO = parseFloat(document.getElementById('L').value) || 1.56;
        const A_FIXA = parseFloat(document.getElementById('A').value) || 0.90;
        const M_FIXA = parseFloat(document.getElementById('M').value) || 7.00;

        let folhaValue = parseInt(card.querySelector('.input-folha').value) || 0;
        let somaMoldes = 0;

        card.querySelectorAll('tbody tr').forEach(row => {
            let pedido = parseInt(row.querySelector('.ped-val').innerText);
            let inputM = row.querySelector('.input-molde');
            
            // Se o usu√°rio mudou a FOLHA, recalculamos o MOLDE sugerido
            if (isFolhaInput && folhaValue > 0) {
                inputM.value = Math.round(pedido / folhaValue) || 1;
            }

            let moldeValue = parseInt(inputM.value) || 0;
            let totalProduzido = folhaValue * moldeValue;
            let saldo = totalProduzido - pedido;

            row.querySelector('.res-total').innerText = totalProduzido;
            let tdSaldo = row.querySelector('.res-saldo');
            tdSaldo.innerText = (saldo >= 0 ? "+" : "") + saldo;
            tdSaldo.className = "res-saldo " + (saldo >= 0 ? "sobra" : "falta");
            
            somaMoldes += moldeValue;
        });

        let riscoFinal = (somaMoldes * A_FIXA) / L_FIXO;
        card.querySelector('.risco-val').innerText = riscoFinal.toFixed(2);
        card.querySelector('.mesa-status-icon').innerHTML = (riscoFinal <= M_FIXA ? "‚úÖ" : "‚ö†Ô∏è PASSA") + " (" + M_FIXA + "m)";
        card.querySelector('.mesa-status-icon').style.color = riscoFinal <= M_FIXA ? "green" : "red";
    };

    // Atribui os eventos de escuta
    card.querySelector('.input-folha').addEventListener('input', calcInterno);
    card.querySelectorAll('.input-molde').forEach(inp => {
        inp.addEventListener('input', calcInterno);
    });

    // Roda o c√°lculo inicial para preencher a tabela
    calcInterno();
}

// Inicializa a grade padr√£o
setGrade([['38',20],['40',20],['42',20],['44',40],['46',30],['48',30],['50',30],['52',20],['54',20],['56',20],['58',20]]);
</script>
</body>
</html>